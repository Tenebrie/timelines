version: '3.8'
services:
    gatekeeper:
        image: tenebrie/timelines-gatekeeper:${VERSION}
        build:
            context: ./app/gatekeeper-proxy
            dockerfile: ./Dockerfile.prod
        deploy:
            replicas: 1
            update_config:
                order: start-first
                parallelism: 1
                delay: 10s
                failure_action: pause
        secrets:
            - environment
        volumes:
            - /mnt/volume_secrets/certs:/etc/letsencrypt:cached
    styx:
        image: tenebrie/timelines-styx:${VERSION}
        build:
            context: ./
            dockerfile: ./app/styx-frontend/Dockerfile.prod
            args:
                VERSION: ${VERSION}
        # nginx runs automatically, no command needed
        deploy:
            replicas: 2
            update_config:
                order: start-first
                parallelism: 2
                delay: 10s
                failure_action: pause
        secrets:
            - environment
        healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080"]
            interval: 1m30s
            timeout: 30s
            retries: 2
            start_period: 30s
    rhea:
        image: tenebrie/timelines-rhea:${VERSION}
        build:
            context: ./
            dockerfile: ./app/rhea-backend/Dockerfile.prod
        environment:
            NODE_ENV: production # Prod or staging
            DATABASE_URL: postgresql://docker:docker@rhea-postgres:5432/db?schema=public
        command: yarn prod
        deploy:
            replicas: 2
            update_config:
                order: start-first
                parallelism: 1
                delay: 10s
                failure_action: pause
        secrets:
            - jwt-secret
            - environment
            - s3-bucket-id
            - s3-endpoint
            - s3-access-key-id
            - s3-access-key-secret
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
            interval: 10s
            timeout: 10s
            retries: 3
            start_period: 300s
    calliope:
        image: tenebrie/timelines-calliope:${VERSION}
        build:
            context: ./
            dockerfile: ./app/calliope-websockets/Dockerfile.prod
        environment:
            NODE_ENV: production # Prod or staging
        command: yarn prod
        deploy:
            replicas: 2
            update_config:
                order: start-first
                parallelism: 1
                delay: 10s
                failure_action: pause
        secrets:
            - jwt-secret
            - environment
    orpheus:
        image: tenebrie/timelines-orpheus:${VERSION}
        build:
            context: ./
            dockerfile: ./app/orpheus-mcp/Dockerfile.prod
        environment:
            NODE_ENV: production # Prod or staging
            REQUIRE_OAUTH: "true"
        command: yarn prod
        deploy:
            replicas: 1
            update_config:
                order: start-first
                parallelism: 1
                delay: 10s
                failure_action: pause
        secrets:
            - jwt-secret
            - environment
    rhea-postgres:
        volumes:
            - /mnt/volume_rhea_postgres/data:/var/lib/postgresql/data/:cached
            - /mnt/volume_rhea_postgres/backups:/backups:cached

    chronos:
        image: tenebrie/timelines-chronos:${VERSION}
        build:
            context: ./app/chronos-backups
            dockerfile: ./Dockerfile
        environment:
            BACKREST_DATA: /data
            BACKREST_CONFIG: /config/config.json
            XDG_CACHE_HOME: /cache
        deploy:
            replicas: 1
            update_config:
                order: stop-first
                parallelism: 1
                delay: 10s
                failure_action: pause
        secrets:
            - s3-bucket-id
            - s3-endpoint
            - s3-access-key-id
            - s3-access-key-secret
        volumes:
            - /mnt/volume_rhea_postgres/backrest/data:/data:cached
            - /mnt/volume_rhea_postgres/backrest/config:/config:cached
            - /mnt/volume_rhea_postgres/backrest/cache:/cache:cached
        depends_on:
            - rhea-postgres
        healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "http://localhost:9898"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

# See docs/Creating New Cluster.md
secrets:
    jwt-secret:
        external: true
    environment:
        external: true
    s3-bucket-id:
        external: true
    s3-endpoint:
        external: true
    s3-access-key-id:
        external: true
    s3-access-key-secret:
        external: true